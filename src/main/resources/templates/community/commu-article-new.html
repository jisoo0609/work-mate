<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>새 게시글 작성하기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>

<!-- 게시판 목록 -->
<div class="d-flex justify-content-center mt-3 fs-6">
  <a th:href="@{'/' + ${shopId} + '/community'}" class="btn btn-primary me-3">전체 게시판</a>
  <div th:each="boardItem : ${boards}">
    <a th:href="@{'/' + ${shopId} + '/community/' + ${boardItem.name()}}" th:text="${boardItem.board}"
       class=" btn btn-info me-3"></a>
  </div>
</div>
<hr>

<body class="p-3" data-shop-id="${shopId}" >
<div class="container mt-3 mb-5">
  <!-- 선택한 게시판 이름 -->
  <div class="d-flex align-items-center">
    <h1 class="me-3" th:if="${board == null}">전체 게시글</h1>
    <h1 class="me-3" th:unless="${board == null}" th:text="${board.board}">게시판 이름</h1>
  </div>
  <hr>
  <!-- 게시글 작성 폼 안내 -->
  <div class="d-flex align-items-center">
    <h1 class="me-3">게시글 작성</h1>
    <a class="fs-3" th:href="@{'/' + ${shopId} + '/community'}">뒤로가기</a>
  </div>
  <hr>

  <form th:action="@{'/' + ${shopId} + '/community/article/create'}" method="post">
    <!-- 게시판 선택 폼 일부 -->
    <div class="mb-3">
      <label for="board-select" class="form-label" >게시판</label>
      <select name="board" id="board-select" class="form-select" onchange="togglePasswordInput(this)">
        <option th:each="board : ${boards}"
                th:value="${board.name()}"
                th:text="${board.board}"
                th:selected="${board != null and board.name() == board.name()}">게시판 이름
        </option>
      </select>

      <!-- 제목 입력 폼 일부  -->
      <div class="mb-3">
        <label for="title-input" class="form-label">제목</label>
        <input type="text" name="title" class="form-control" id="title-input">
      </div>

      <!-- 내용 입력 폼 일부 -->
      <div class="mb-3">
        <label for="content-area" class="form-label">내용</label>
        <textarea name="content" id="content-area" class="form-control"></textarea>
      </div>
    </div>

    <!-- 비밀번호 입력 폼 일부 -->
    <div class="mb-3" id="password-container" style="display:none;">
      <label for="password-input" class="form-label">비밀번호</label>
      <input type="password" name="password" id="password-input" class="form-control">
    </div>

    <!-- 폼 제출 버튼 -->
    <input type="submit" value="글쓰기" class="btn btn-primary">
  </form>
</div>
<script>
    window.onload = function() {
        var boardSelect = document.getElementById('board-select');
        togglePasswordInput(boardSelect);
    };

    function togglePasswordInput(select) {
        var passwordContainer = document.getElementById('password-container');
        var selectedValue = select.value;
        if(selectedValue === "SECRET") {
            passwordContainer.style.display = 'block';
        } else {
            passwordContainer.style.display = 'none';
        }
    }
</script>

// 헤더에 token 담아서 post
<script th:inline="javascript">
    $(document).ready(function (){
        // 프론트에서 저장된 jwt 토큰을 받아옴
        const token = localStorage.getItem("jwtToken");

        // 프론트에서 저장된 shop id를 받아옴
        const shopId = "[[${shopId}]]";

        $.ajax({
            url: `/${shopId}/community/article/new`,
            type: "GET",
            headers: {
                "Authorization": "Bearer " + token // Bearer 토큰을 Authorization 헤더에 추가
            },
            contentType: "application/json"
        })


        // 폼 제출 이벤트 핸들러
        $("#form").submit(function (e) {
            e.preventDefault(); // 폼의 기본 제출 방지

            // 폼 데이터를 JSON 객체로 변환
            const formData = {
                title: $('input[name="title"]').val(),
                content: $('input[name="content"]').val(),
                password: $('input[name="password"]').val()
            };

            $.ajax({
                url: `/${shopId}/community/article/create`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                headers: {
                    "Authorization": "Bearer " + token // Bearer 토큰을 Authorization 헤더에 추가
                },

                // 성공 처리
                success: function (response) {
                    alert("게시글이 성공적으로 작성되었습니다.");
                    window.location.href = "/${shopId}/community";
                },
                // 실패 처리
                error: function (xhr, status, error) {
                    alert("게시글 작성에 실패했습니다. 에러: " + xhr.responseText);
                    console.log(xhr);
                    console.log(status);
                    console.log(error);
                }
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>
</html>